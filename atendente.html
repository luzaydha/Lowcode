<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Atendimento ao Paciente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col h-screen">

    <header class="w-full bg-white p-4 border-b border-slate-200 flex justify-between items-center shadow-sm flex-shrink-0">
        <!-- Logo/Title -->
        <h1 class="text-2xl font-bold">
            <span class="bg-gradient-to-r from-sky-500 to-teal-400 bg-clip-text text-transparent">
                MediConnect Pro
            </span>
        </h1>

        <!-- User Info -->
        <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-2 text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 4c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0 13c-2.33 0-4.31-.81-5.91-2.13C7.61 15.01 10.13 14 12 14s4.39 1.01 5.91 2.87C16.31 18.19 14.33 19 12 19z"/></svg>
                <span class="font-medium">Atendente: Fernanda Dias</span>
            </div>
            <a href="login_clinica.html" class="flex items-center space-x-2 text-slate-500 hover:text-red-600 transition-colors font-medium">Sair</a>
        </div>
    </header>

    <div id="app" class="flex-1 w-full flex flex-col md:flex-row antialiased overflow-hidden">

        <!-- Sidebar com a lista de pacientes -->
        <aside class="w-full md:w-1/3 lg:w-1/4 border-r border-slate-200 bg-white flex flex-col h-full">
            <div id="patient-list" class="flex-1 overflow-y-auto custom-scrollbar">
                <!-- Lista de pacientes será injetada aqui pelo JavaScript -->
            </div>
        </aside>

        <!-- Área principal da conversa -->
        <main id="conversation-view" class="flex-1 flex flex-col bg-slate-50 h-2/3 md:h-full">
            <!-- Tela inicial quando nenhuma conversa está selecionada -->
            <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center p-8">
                 <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400 mb-4"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <h2 class="text-2xl font-semibold text-slate-700">Bem-vindo(a), Atendente!</h2>
                <p class="mt-2 text-slate-500">Selecione uma conversa na lista ao lado para começar.</p>
            </div>

            <!-- Header da conversa (visível quando uma conversa é selecionada) -->
            <header id="conversation-header" class="hidden p-4 border-b border-slate-200 bg-white flex items-center space-x-3">
                <img id="chat-avatar" src="" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
                <div>
                    <h2 id="chat-name" class="text-lg font-semibold text-slate-900"></h2>
                    <p class="text-sm text-green-600 font-medium">Online</p>
                </div>
            </header>

            <!-- Corpo da conversa (visível quando uma conversa é selecionada) -->
            <div id="chat-body" class="hidden flex-1 p-4 md:p-6 overflow-y-auto custom-scrollbar">
                 <!-- Mensagens serão injetadas aqui -->
            </div>

            <!-- Rodapé para registrar informações (visível quando uma conversa é selecionada) -->
            <footer id="conversation-footer" class="hidden p-4 bg-white border-t border-slate-200">
                <div class="flex items-center space-x-3">
                    <textarea id="message-input" rows="1" class="flex-1 p-3 bg-slate-100 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent transition" placeholder="Digite uma mensagem ou /info para registrar..."></textarea>
                    <button id="schedule-button" title="Agendar Consulta" class="text-slate-500 hover:text-teal-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-colors flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </button>
                    <button id="send-button" class="bg-gradient-to-r from-sky-500 to-teal-400 text-white rounded-lg p-3 hover:from-sky-600 hover:to-teal-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </footer>
        </main>
    </div>

    <!-- Modal de Agendamento -->
    <div id="schedule-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-auto transform transition-all">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800">Agendar Consulta</h3>
                <button id="close-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-5">
                <!-- Calendário -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month-button" class="p-2 rounded-full hover:bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        </button>
                        <h4 id="month-year-header" class="font-semibold text-center"></h4>
                        <button id="next-month-button" class="p-2 rounded-full hover:bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center text-sm text-gray-500 mb-2">
                        <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                        <!-- Dias serão injetados aqui -->
                    </div>
                </div>
                <!-- Horários Disponíveis -->
                <div>
                    <h4 class="font-semibold mb-3">Horários Disponíveis (<span id="selected-date-display">--/--</span>)</h4>
                    <div id="time-slots" class="flex flex-wrap gap-2">
                         <p class="text-sm text-gray-500 w-full">Selecione uma data para ver os horários.</p>
                    </div>
                </div>
            </div>
            <div class="p-5 bg-gray-50 rounded-b-lg">
                 <button id="confirm-schedule-button" class="w-full bg-gradient-to-r from-sky-500 to-teal-400 text-white font-bold py-3 px-4 rounded-lg hover:from-sky-600 hover:to-teal-500 transition-all disabled:from-sky-200 disabled:to-teal-200 disabled:cursor-not-allowed">
                    Confirmar Agendamento
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Dados de exemplo (mock data)
            const patientsData = [
                {
                    id: 1,
                    name: 'Ana Silva',
                    avatar: 'https://placehold.co/100x100/7DD3FC/1E40AF?text=AS',
                    source: 'WhatsApp',
                    status: 'Em andamento',
                    messages: [
                        { sender: 'patient', text: 'Bom dia, gostaria de saber o resultado do meu exame de sangue.', timestamp: '10:30' },
                        { sender: 'attendant', text: 'Bom dia, Ana! Só um momento, vou verificar no sistema.', timestamp: '10:31' },
                        { sender: 'attendant', text: 'Verifiquei aqui. O resultado já está disponível no portal do paciente.', timestamp: '10:33' },
                    ]
                },
                {
                    id: 2,
                    name: 'Bruno Costa',
                    avatar: 'https://placehold.co/100x100/5EEAD4/0F766E?text=BC',
                    source: 'Instagram',
                    status: 'Aguardando',
                    messages: [
                        { sender: 'patient', text: 'Olá, gostaria de agendar um exame de ressonância magnética, por favor.', timestamp: '11:20' },
                        { sender: 'attendant', text: 'Claro, Bruno. Para qual data você gostaria de agendar?', timestamp: '11:21' }
                    ]
                },
                {
                    id: 3,
                    name: 'Carlos Oliveira',
                    avatar: 'https://placehold.co/100x100/A3E635/3F6212?text=CO',
                    source: 'Facebook',
                    status: 'Em andamento',
                    messages: [
                        { sender: 'patient', text: 'Qual o preparo para o exame de ultrassom abdominal?', timestamp: '08:12' },
                    ]
                },
                {
                    id: 4,
                    name: 'Daniela Ferreira',
                    avatar: 'https://placehold.co/100x100/6EE7B7/065F46?text=DF',
                    source: 'WhatsApp',
                    status: 'Finalizado',
                    messages: [
                        { sender: 'patient', text: 'Entreguei os documentos na recepção.', timestamp: '09:45' },
                        { sender: 'internal_note', text: 'Paciente entregou exames anteriores na recepção. Anexar ao prontuário.', timestamp: '09:50' },
                    ]
                },
            ];

            let activePatientId = null;

            // --- STATE & DATA P/ AGENDAMENTO ---
            let currentDateForCalendar = new Date();
            let selectedDate = null;
            let selectedTime = null;
            
            function getAvailableTimesForDate(date) {
                if (!date) return [];

                const dayOfWeek = date.getDay();
                // Sem agendamentos nos fins de semana (Domingo = 0, Sábado = 6)
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    return [];
                }

                // Adiciona uma data de início para disponibilidade
                const startDate = new Date('2025-09-12T00:00:00');
                // Zera as horas da data selecionada para comparar apenas os dias
                const selectedDay = new Date(date.getTime());
                selectedDay.setHours(0, 0, 0, 0);

                if (selectedDay < startDate) {
                    return []; // Retorna array vazio para datas antes de 12/09/2025
                }

                const allTimes = [];
                // Usa uma cópia para evitar modificar o objeto de data original
                let currentTime = new Date(date.getTime());
                currentTime.setHours(8, 0, 0, 0); // Começa às 8:00

                const endTime = new Date(date.getTime());
                endTime.setHours(17, 30, 0, 0); // Alterado: Último horário é 17:30

                while (currentTime <= endTime) {
                    const hour = currentTime.getHours();
                    // Pausa do almoço das 11:00 (inclusivo) às 13:00 (exclusivo)
                    if (hour < 11 || hour >= 13) {
                        allTimes.push(currentTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }));
                    }
                    currentTime.setMinutes(currentTime.getMinutes() + 30);
                }

                // Alterado: Remove a simulação de horários ocupados para mostrar todos "sem exceção"
                // const seed = date.getDate();
                // const availableSlots = allTimes.filter((_, index) => {
                //     return (Math.sin(seed * index) * 10000) % 1 > 0.3;
                // });
                
                return allTimes; // Retorna todos os horários calculados
            }


            // --- ELEMENTOS DA DOM ---
            const patientListEl = document.getElementById('patient-list');
            const welcomeScreenEl = document.getElementById('welcome-screen');
            const conversationHeaderEl = document.getElementById('conversation-header');
            const chatBodyEl = document.getElementById('chat-body');
            const conversationFooterEl = document.getElementById('conversation-footer');
            const chatAvatarEl = document.getElementById('chat-avatar');
            const chatNameEl = document.getElementById('chat-name');
            const messageInputEl = document.getElementById('message-input');
            const sendButtonEl = document.getElementById('send-button');
            const scheduleButtonEl = document.getElementById('schedule-button');
            const scheduleModalEl = document.getElementById('schedule-modal');
            const closeModalButtonEl = document.getElementById('close-modal-button');
            const monthYearHeaderEl = document.getElementById('month-year-header');
            const calendarGridEl = document.getElementById('calendar-grid');
            const prevMonthButtonEl = document.getElementById('prev-month-button');
            const nextMonthButtonEl = document.getElementById('next-month-button');
            const selectedDateDisplayEl = document.getElementById('selected-date-display');
            const timeSlotsEl = document.getElementById('time-slots');
            const confirmScheduleButtonEl = document.getElementById('confirm-schedule-button');


            // --- FUNÇÕES DE RENDERIZAÇÃO ---
            function getStatusClasses(status) {
                switch (status.toLowerCase()) {
                    case 'em andamento':
                        return 'bg-green-100 text-green-800';
                    case 'aguardando':
                        return 'bg-amber-100 text-amber-800';
                    case 'finalizado':
                        return 'bg-slate-200 text-slate-600';
                    default:
                        return 'bg-gray-100 text-gray-800';
                }
            }

            function renderPatientList() {
                patientListEl.innerHTML = '';
                patientsData.forEach(patient => {
                    const lastMessage = patient.messages[patient.messages.length - 1];
                    const isActive = patient.id === activePatientId;

                    const patientItem = document.createElement('div');
                    patientItem.className = `p-4 flex items-center space-x-4 cursor-pointer border-l-4 ${isActive ? 'border-teal-500 bg-teal-50' : 'border-transparent'} hover:bg-slate-100 transition-colors`;
                    patientItem.dataset.patientId = patient.id;

                    patientItem.innerHTML = `
                        <img src="${patient.avatar}" alt="${patient.name}" class="w-12 h-12 rounded-full object-cover flex-shrink-0">
                        <div class="flex-1 min-w-0">
                             <div class="flex justify-between items-start space-x-2">
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-semibold text-slate-800 truncate">${patient.name}</h3>
                                    <p class="text-sm text-slate-500 truncate">${patient.source} · ${lastMessage.timestamp}</p>
                                </div>
                                <span class="${getStatusClasses(patient.status)} text-xs font-medium px-2.5 py-1 rounded-full whitespace-nowrap flex-shrink-0">
                                    ${patient.status}
                                </span>
                            </div>
                        </div>
                    `;
                    patientListEl.appendChild(patientItem);
                });
            }

            function renderConversation(patientId) {
                const patient = patientsData.find(p => p.id === patientId);
                if (!patient) return;
                welcomeScreenEl.classList.add('hidden');
                conversationHeaderEl.classList.remove('hidden');
                chatBodyEl.classList.remove('hidden');
                conversationFooterEl.classList.remove('hidden');
                chatAvatarEl.src = patient.avatar;
                chatAvatarEl.alt = patient.name;
                chatNameEl.textContent = patient.name;
                chatBodyEl.innerHTML = '';
                patient.messages.forEach(msg => {
                    const messageEl = document.createElement('div');
                    if (msg.sender === 'patient') {
                        messageEl.className = 'flex justify-start mb-4';
                        messageEl.innerHTML = `
                            <div class="max-w-xs md:max-w-md lg:max-w-lg">
                                <div class="bg-white p-3 rounded-lg rounded-bl-none shadow-sm">
                                    <p class="text-slate-700">${msg.text}</p>
                                </div>
                                <span class="text-xs text-slate-400 mt-1 block">${msg.timestamp}</span>
                            </div>
                        `;
                    } else if (msg.sender === 'attendant') {
                        messageEl.className = 'flex justify-end mb-4';
                        messageEl.innerHTML = `
                            <div class="max-w-xs md:max-w-md lg:max-w-lg text-right">
                                <div class="bg-sky-500 text-white p-3 rounded-lg rounded-br-none shadow-sm">
                                    <p>${msg.text}</p>
                                </div>
                                <span class="text-xs text-slate-400 mt-1 block">${msg.timestamp}</span>
                            </div>
                        `;
                    } else if (msg.sender === 'internal_note') {
                        messageEl.className = 'flex justify-center mb-4';
                        messageEl.innerHTML = `
                            <div class="text-center text-xs text-slate-500 bg-yellow-100 border border-yellow-200 rounded-full py-1 px-4">
                                <strong>Nota Interna:</strong> ${msg.text} (${msg.timestamp})
                            </div>
                        `;
                    } else if (msg.sender === 'system_info') {
                        messageEl.className = 'flex justify-center mb-4';
                        messageEl.innerHTML = `
                            <div class="text-center text-sm font-medium text-slate-700 bg-slate-200 border border-slate-300 rounded-lg py-2 px-4 max-w-md shadow-sm">
                                ${msg.text} <span class="text-slate-500 text-xs font-normal">(${msg.timestamp})</span>
                            </div>
                        `;
                    }
                    chatBodyEl.appendChild(messageEl);
                });
                chatBodyEl.scrollTop = chatBodyEl.scrollHeight;
            }
            
            function renderCalendar() {
                const year = currentDateForCalendar.getFullYear();
                const month = currentDateForCalendar.getMonth();
                const today = new Date();

                monthYearHeaderEl.textContent = new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                calendarGridEl.innerHTML = '';

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarGridEl.innerHTML += '<div></div>';
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const isToday = date.toDateString() === today.toDateString();
                    const isSelected = selectedDate && date.toDateString() === selectedDate.toDateString();
                    
                    const dayEl = document.createElement('button');
                    dayEl.textContent = day;
                    dayEl.dataset.date = date.toISOString();
                    dayEl.className = `w-10 h-10 flex items-center justify-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500`;
                    
                    if (isSelected) {
                        dayEl.classList.add('bg-teal-500', 'text-white', 'font-bold');
                    } else if (isToday) {
                        dayEl.classList.add('bg-teal-100', 'text-teal-700');
                    } else {
                        dayEl.classList.add('hover:bg-slate-100');
                    }
                    calendarGridEl.appendChild(dayEl);
                }
            }

            function renderTimeSlots() {
                timeSlotsEl.innerHTML = '';
                if (!selectedDate) {
                    timeSlotsEl.innerHTML = '<p class="text-sm text-gray-500 w-full">Selecione uma data para ver os horários.</p>';
                    selectedDateDisplayEl.textContent = '--/--';
                    return;
                }

                selectedDateDisplayEl.textContent = selectedDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                const times = getAvailableTimesForDate(selectedDate);

                if (times.length === 0) {
                    timeSlotsEl.innerHTML = '<p class="text-sm text-gray-500 w-full">Não há horários disponíveis para esta data.</p>';
                    return;
                }

                times.forEach(time => {
                    const isSelected = time === selectedTime;
                    const timeBtn = document.createElement('button');
                    timeBtn.textContent = time;
                    timeBtn.dataset.time = time;
                    timeBtn.className = `py-2 px-4 rounded-lg border transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-teal-500 ${isSelected ? 'bg-gradient-to-r from-sky-500 to-teal-400 text-white border-transparent' : 'bg-white hover:bg-slate-100 border-gray-300'}`;
                    timeSlotsEl.appendChild(timeBtn);
                });
            }

            // --- FUNÇÕES DE MANIPULAÇÃO DE DADOS ---
            function addMessage(patientId, text) {
                const patient = patientsData.find(p => p.id === patientId);
                if (!patient) return;

                let senderType = 'attendant';
                let messageText = text;

                if (text.toLowerCase().startsWith('/nota ')) {
                    senderType = 'internal_note';
                    messageText = text.substring(6).trim();
                } else if (text.toLowerCase().startsWith('/info ')) {
                    senderType = 'system_info';
                    messageText = text.substring(6).trim();
                }
                
                if (!messageText) return;

                const newMessage = {
                    sender: senderType,
                    text: messageText,
                    timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                };
                patient.messages.push(newMessage);

                renderConversation(patientId);
                renderPatientList(); 
            }
            
            // --- FUNÇÕES DO MODAL ---
            function openScheduleModal() {
                if (!activePatientId) {
                    console.warn("Selecione um paciente para agendar uma consulta.");
                    return;
                }
                selectedDate = null;
                selectedTime = null;
                currentDateForCalendar = new Date();
                scheduleModalEl.classList.remove('hidden');
                renderCalendar();
                renderTimeSlots();
                updateConfirmButtonState();
            }

            function closeScheduleModal() {
                scheduleModalEl.classList.add('hidden');
            }
            
            function updateConfirmButtonState() {
                confirmScheduleButtonEl.disabled = !(selectedDate && selectedTime);
            }

            // --- MANIPULADORES DE EVENTOS ---
            patientListEl.addEventListener('click', (e) => {
                const patientItem = e.target.closest('[data-patient-id]');
                if (patientItem) {
                    const patientId = parseInt(patientItem.dataset.patientId, 10);
                    activePatientId = patientId;
                    renderPatientList();
                    renderConversation(patientId);
                    messageInputEl.focus();
                }
            });

            function handleSendMessage() {
                const messageText = messageInputEl.value.trim();
                if (messageText && activePatientId) {
                    addMessage(activePatientId, messageText);
                    messageInputEl.value = '';
                    messageInputEl.style.height = 'auto'; 
                }
            }
            
            sendButtonEl.addEventListener('click', handleSendMessage);
            messageInputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
            
            messageInputEl.addEventListener('input', () => {
                messageInputEl.style.height = 'auto';
                messageInputEl.style.height = (messageInputEl.scrollHeight) + 'px';
            });
            
            scheduleButtonEl.addEventListener('click', openScheduleModal);
            closeModalButtonEl.addEventListener('click', closeScheduleModal);
            scheduleModalEl.addEventListener('click', (e) => {
                if (e.target === scheduleModalEl) closeScheduleModal();
            });

            prevMonthButtonEl.addEventListener('click', () => {
                currentDateForCalendar.setMonth(currentDateForCalendar.getMonth() - 1);
                renderCalendar();
            });

            nextMonthButtonEl.addEventListener('click', () => {
                currentDateForCalendar.setMonth(currentDateForCalendar.getMonth() + 1);
                renderCalendar();
            });

            calendarGridEl.addEventListener('click', (e) => {
                const dayButton = e.target.closest('button[data-date]');
                if (dayButton) {
                    selectedDate = new Date(dayButton.dataset.date);
                    selectedTime = null; 
                    renderCalendar();
                    renderTimeSlots();
                    updateConfirmButtonState();
                }
            });

            timeSlotsEl.addEventListener('click', (e) => {
                const timeButton = e.target.closest('button[data-time]');
                if (timeButton) {
                    selectedTime = timeButton.dataset.time;
                    renderTimeSlots();
                    updateConfirmButtonState();
                }
            });
            
            confirmScheduleButtonEl.addEventListener('click', () => {
                if (!selectedDate || !selectedTime || !activePatientId) return;
                
                const weekDay = selectedDate.toLocaleDateString('pt-BR', { weekday: 'long' });
                const formattedWeekDay = weekDay.charAt(0).toUpperCase() + weekDay.slice(1);
                const dayAndMonth = selectedDate.toLocaleDateString('pt-BR', { day: 'numeric', month: 'long' });

                const messageText = `Olá! Tudo bem? Sua consulta foi agendada para ${formattedWeekDay}, dia ${dayAndMonth}, às ${selectedTime}h em nossa clínica. Pedimos que chegue com 10 minutinhos de antecedência para que possamos recebê-lo. Estamos à disposição para qualquer dúvida e será um prazer cuidar de você.`;
                
                addMessage(activePatientId, messageText);
                
                closeScheduleModal();
            });

            // --- INICIALIZAÇÃO ---
            function init() {
                renderPatientList();
                updateConfirmButtonState();
            }

            init();
        });
    </script>

</body>
</html>